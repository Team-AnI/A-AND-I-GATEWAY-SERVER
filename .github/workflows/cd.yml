name: CD

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      ECR_REPOSITORY: aandi-gateway-server
      CONTAINER_NAME: aandi-gateway-server
      AWS_REGION: ${{ secrets.AWS_REGION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Run tests
        run: ./gradlew test

      - name: Build JAR
        run: ./gradlew build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: github-actions-cd
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.ref_name }}

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.2.1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
            IMAGE_URI="${ECR_REGISTRY}/${{ env.ECR_REPOSITORY }}:${{ github.ref_name }}"
            DOMAIN="api.aandiclub.com"
            AUTH_ISSUER_URI="${{ vars.AUTH_ISSUER_URI }}"
            AUTH_AUDIENCE="${{ vars.AUTH_AUDIENCE }}"
            ALLOWED_HOSTS="${{ vars.ALLOWED_HOSTS }}"
            ALLOW_PRIVATE_IP_HOST="${{ vars.ALLOW_PRIVATE_IP_HOST }}"
            ENFORCE_HTTPS="${{ vars.ENFORCE_HTTPS }}"
            CORS_ALLOWED_ORIGIN_PATTERNS="${{ vars.CORS_ALLOWED_ORIGIN_PATTERNS }}"
            AUTH_SERVICE_URI="${{ secrets.AUTH_SERVICE_URI }}"
            REPORT_SERVICE_URI="${{ secrets.REPORT_SERVICE_URI }}"
            POST_SERVICE_URI="${{ secrets.POST_SERVICE_URI }}"
            AUTH_JWT_SECRET="${{ secrets.AUTH_JWT_SECRET }}"

            if [ -z "$AUTH_ISSUER_URI" ]; then AUTH_ISSUER_URI="${{ secrets.AUTH_ISSUER_URI }}"; fi
            if [ -z "$AUTH_AUDIENCE" ]; then AUTH_AUDIENCE="${{ secrets.AUTH_AUDIENCE }}"; fi
            if [ -z "$ALLOWED_HOSTS" ]; then ALLOWED_HOSTS="${{ secrets.ALLOWED_HOSTS }}"; fi
            if [ -z "$ALLOW_PRIVATE_IP_HOST" ]; then ALLOW_PRIVATE_IP_HOST="${{ secrets.ALLOW_PRIVATE_IP_HOST }}"; fi
            if [ -z "$ENFORCE_HTTPS" ]; then ENFORCE_HTTPS="${{ secrets.ENFORCE_HTTPS }}"; fi
            if [ -z "$CORS_ALLOWED_ORIGIN_PATTERNS" ]; then CORS_ALLOWED_ORIGIN_PATTERNS="${{ secrets.CORS_ALLOWED_ORIGIN_PATTERNS }}"; fi

            if [ -z "$AUTH_ISSUER_URI" ]; then AUTH_ISSUER_URI="https://auth.aandiclub.com"; fi
            if [ -z "$AUTH_AUDIENCE" ]; then AUTH_AUDIENCE="aandiclub-api"; fi
            if [ -z "$ALLOWED_HOSTS" ]; then ALLOWED_HOSTS="$DOMAIN"; fi
            if [ -z "$ALLOW_PRIVATE_IP_HOST" ]; then ALLOW_PRIVATE_IP_HOST="true"; fi
            if [ -z "$ENFORCE_HTTPS" ]; then ENFORCE_HTTPS="true"; fi
            if [ -z "$CORS_ALLOWED_ORIGIN_PATTERNS" ]; then CORS_ALLOWED_ORIGIN_PATTERNS="https://*"; fi

            [ -n "$AUTH_SERVICE_URI" ] || { echo "Missing secret: AUTH_SERVICE_URI"; exit 1; }
            [ -n "$REPORT_SERVICE_URI" ] || { echo "Missing secret: REPORT_SERVICE_URI"; exit 1; }
            [ -n "$POST_SERVICE_URI" ] || { echo "Missing secret: POST_SERVICE_URI"; exit 1; }
            [ -n "$AUTH_JWT_SECRET" ] || { echo "Missing secret: AUTH_JWT_SECRET"; exit 1; }

            aws ecr get-login-password --region "${{ env.AWS_REGION }}" | sudo docker login --username AWS --password-stdin "${ECR_REGISTRY}"
            sudo mkdir -p /opt/aandi/gateway
            sudo mkdir -p /opt/aandi/gateway/nginx /opt/aandi/gateway/certbot/conf /opt/aandi/gateway/certbot/www
            sudo docker rm -f \
              ${{ env.CONTAINER_NAME }} \
              aandi-gateway-redis \
              aandi-gateway-nginx \
              aandi-gateway-nginx-bootstrap || true
            sudo tee /opt/aandi/gateway/nginx/bootstrap.conf >/dev/null <<EOF_BOOTSTRAP
            server {
              listen 80;
              server_name ${DOMAIN};

              location /.well-known/acme-challenge/ {
                root /var/www/certbot;
              }

              location / {
                return 200 'cert-bootstrap';
              }
            }
            EOF_BOOTSTRAP

            if [ ! -f "/opt/aandi/gateway/certbot/conf/live/${DOMAIN}/fullchain.pem" ]; then
              sudo tee /opt/aandi/gateway/docker-compose.bootstrap.yml >/dev/null <<EOF_BOOTSTRAP_COMPOSE
            services:
              nginx:
                image: nginx:1.27-alpine
                container_name: aandi-gateway-nginx-bootstrap
                restart: unless-stopped
                ports:
                  - "80:80"
                volumes:
                  - /opt/aandi/gateway/nginx/bootstrap.conf:/etc/nginx/conf.d/default.conf:ro
                  - /opt/aandi/gateway/certbot/www:/var/www/certbot:ro
            EOF_BOOTSTRAP_COMPOSE
              cd /opt/aandi/gateway
              sudo docker compose -f docker-compose.bootstrap.yml up -d
              sudo docker run --rm \
                -v /opt/aandi/gateway/certbot/www:/var/www/certbot \
                -v /opt/aandi/gateway/certbot/conf:/etc/letsencrypt \
                certbot/certbot certonly --webroot \
                -w /var/www/certbot \
                -d "${DOMAIN}" \
                --email "${{ secrets.LETSENCRYPT_EMAIL }}" \
                --agree-tos \
                --no-eff-email
              sudo docker compose -f docker-compose.bootstrap.yml down
            fi

            sudo tee /opt/aandi/gateway/nginx/gateway.conf >/dev/null <<EOF_NGINX
            server {
              listen 80;
              server_name ${DOMAIN};

              location /.well-known/acme-challenge/ {
                root /var/www/certbot;
              }

              location / {
                return 301 https://\$host\$request_uri;
              }
            }

            server {
              listen 443 ssl;
              http2 on;
              server_name ${DOMAIN};

              ssl_certificate /etc/letsencrypt/live/${DOMAIN}/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/live/${DOMAIN}/privkey.pem;
              ssl_session_timeout 1d;
              ssl_session_cache shared:SSL:10m;
              ssl_protocols TLSv1.2 TLSv1.3;

              location /internal/ {
                allow 172.31.0.0/16;
                deny all;
                proxy_pass http://gateway:8080;
                proxy_set_header Host \$host;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
              }

              location /actuator/ {
                deny all;
                return 403;
              }

              location / {
                proxy_pass http://gateway:8080;
                proxy_set_header Host \$host;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
              }
            }
            EOF_NGINX
            sudo tee /opt/aandi/gateway/docker-compose.yml >/dev/null <<EOF
            services:
              nginx:
                image: nginx:1.27-alpine
                container_name: aandi-gateway-nginx
                restart: unless-stopped
                ports:
                  - "80:80"
                  - "443:443"
                volumes:
                  - /opt/aandi/gateway/nginx/gateway.conf:/etc/nginx/conf.d/default.conf:ro
                  - /opt/aandi/gateway/certbot/conf:/etc/letsencrypt:ro
                  - /opt/aandi/gateway/certbot/www:/var/www/certbot:ro
                depends_on:
                  - gateway

              gateway:
                image: ${IMAGE_URI}
                container_name: ${{ env.CONTAINER_NAME }}
                restart: unless-stopped
                environment:
                  GATEWAY_AUTH_ENABLED: "true"
                  AUTH_ISSUER_URI: "${AUTH_ISSUER_URI}"
                  AUTH_AUDIENCE: "${AUTH_AUDIENCE}"
                  AUTH_JWT_SECRET: "${AUTH_JWT_SECRET}"
                  AUTH_SERVICE_URI: "${AUTH_SERVICE_URI}"
                  REPORT_SERVICE_URI: "${REPORT_SERVICE_URI}"
                  POST_SERVICE_URI: "${POST_SERVICE_URI}"
                  ENFORCE_HTTPS: "${ENFORCE_HTTPS}"
                  ALLOWED_HOSTS: "${ALLOWED_HOSTS}"
                  ALLOW_PRIVATE_IP_HOST: "${ALLOW_PRIVATE_IP_HOST}"
                  CORS_ALLOWED_ORIGIN_PATTERNS: "${CORS_ALLOWED_ORIGIN_PATTERNS}"
                  AUTH_JWT_CLOCK_SKEW_SECONDS: "30"
                  AUTH_RATE_LIMIT_ENABLED: "true"
                  AUTH_LOGIN_RATE_LIMIT_PER_MINUTE: "10"
                  AUTH_REFRESH_RATE_LIMIT_PER_MINUTE: "30"
                  AUTH_LOGOUT_RATE_LIMIT_PER_MINUTE: "30"
                  PREVALIDATE_REFRESH_TOKEN_TYPE: "true"
                  ENFORCE_METHOD_PATH_ALLOWLIST: "true"
                  ENFORCE_JSON_CONTENT_TYPE: "true"
                  MAX_REQUEST_BODY_SIZE: "2MB"
                  MAX_REQUEST_HEADER_SIZE: "16KB"
                  INTERNAL_EVENT_TOKEN: "${{ secrets.INTERNAL_EVENT_TOKEN }}"
                  REDIS_HOST: redis
                  REDIS_PORT: "6379"
                  REDIS_PASSWORD: "${{ secrets.REDIS_PASSWORD }}"
                depends_on:
                  redis:
                    condition: service_healthy

              redis:
                image: redis:7-alpine
                container_name: aandi-gateway-redis
                restart: unless-stopped
                environment:
                  REDIS_PASSWORD: "${{ secrets.REDIS_PASSWORD }}"
                command: >
                  sh -c 'if [ -n "$$REDIS_PASSWORD" ]; then
                  exec redis-server --appendonly yes --requirepass "$$REDIS_PASSWORD";
                  else
                  exec redis-server --appendonly yes;
                  fi'
                healthcheck:
                  test: ["CMD", "redis-cli", "ping"]
                  interval: 5s
                  timeout: 3s
                  retries: 5
            EOF
            cd /opt/aandi/gateway
            sudo docker compose pull nginx gateway redis
            sudo docker compose up -d --remove-orphans nginx gateway redis
            sudo docker run --rm \
              -v /opt/aandi/gateway/certbot/www:/var/www/certbot \
              -v /opt/aandi/gateway/certbot/conf:/etc/letsencrypt \
              certbot/certbot renew --webroot -w /var/www/certbot --quiet || true
            sudo docker image prune -af
