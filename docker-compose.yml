services:
  nginx:
    image: nginx:1.27-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./deploy/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./deploy/certbot/conf:/etc/letsencrypt:ro
      - ./deploy/certbot/www:/var/www/certbot:ro
    depends_on:
      - gateway

  gateway:
    build: .
    environment:
      - AUTH_ISSUER_URI=${AUTH_ISSUER_URI:-http://localhost:9000}
      - AUTH_JWK_SET_URI=${AUTH_JWK_SET_URI:-http://localhost:9000/.well-known/jwks.json}
      - AUTH_AUDIENCE=${AUTH_AUDIENCE:-aandi-gateway}
      - AUTH_JWT_SECRET=${AUTH_JWT_SECRET:-local-dev-jwt-secret-must-be-at-least-32-bytes}
      - AUTH_JWT_CLOCK_SKEW_SECONDS=${AUTH_JWT_CLOCK_SKEW_SECONDS:-30}
      - AUTH_SERVICE_URI=${AUTH_SERVICE_URI:-http://host.docker.internal:9000}
      - REPORT_SERVICE_URI=${REPORT_SERVICE_URI:-http://host.docker.internal:8081}
      - POST_SERVICE_URI=${POST_SERVICE_URI:-http://host.docker.internal:8084}
      - ENFORCE_HTTPS=${ENFORCE_HTTPS:-false}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-}
      - ENFORCE_METHOD_PATH_ALLOWLIST=${ENFORCE_METHOD_PATH_ALLOWLIST:-true}
      - ENFORCE_JSON_CONTENT_TYPE=${ENFORCE_JSON_CONTENT_TYPE:-true}
      - PREVALIDATE_REFRESH_TOKEN_TYPE=${PREVALIDATE_REFRESH_TOKEN_TYPE:-true}
      - AUTH_RATE_LIMIT_ENABLED=${AUTH_RATE_LIMIT_ENABLED:-true}
      - AUTH_LOGIN_RATE_LIMIT_PER_MINUTE=${AUTH_LOGIN_RATE_LIMIT_PER_MINUTE:-10}
      - AUTH_REFRESH_RATE_LIMIT_PER_MINUTE=${AUTH_REFRESH_RATE_LIMIT_PER_MINUTE:-30}
      - AUTH_LOGOUT_RATE_LIMIT_PER_MINUTE=${AUTH_LOGOUT_RATE_LIMIT_PER_MINUTE:-30}
      - MAX_REQUEST_BODY_SIZE=${MAX_REQUEST_BODY_SIZE:-2MB}
      - MAX_REQUEST_HEADER_SIZE=${MAX_REQUEST_HEADER_SIZE:-16KB}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - INTERNAL_EVENT_TOKEN=${INTERNAL_EVENT_TOKEN:-local-dev-internal-token}
      - TOKEN_CACHE_TTL=${TOKEN_CACHE_TTL:-24h}
      - MANAGEMENT_SERVER_PORT=${MANAGEMENT_SERVER_PORT:-9090}
      - MANAGEMENT_SERVER_ADDRESS=${MANAGEMENT_SERVER_ADDRESS:-127.0.0.1}
    depends_on:
      redis:
        condition: service_healthy

  redis:
    image: redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
