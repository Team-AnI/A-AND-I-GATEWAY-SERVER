spring:
  application:
    name: gateway

  codec:
    max-in-memory-size: ${MAX_REQUEST_BODY_SIZE:2MB}

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms

  cloud:
    gateway:
      server:
        webflux:
          globalcors:
            add-to-simple-url-handler-mapping: true
            cors-configurations:
              '[/**]':
                allowed-origin-patterns: ${CORS_ALLOWED_ORIGIN_PATTERNS:https://*}
                allowed-methods:
                  - GET
                  - POST
                  - PUT
                  - PATCH
                  - DELETE
                  - OPTIONS
                allowed-headers: "*"
                exposed-headers:
                  - X-Auth-Context-Cache
                allow-credentials: false
                max-age: 3600
          default-filters:
            - RequestSize=${MAX_REQUEST_BODY_SIZE:2MB}
            - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_FIRST
          routes:
            - id: auth-service-v1-login
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v1/auth/login
                - Method=POST
            - id: auth-service-v1-refresh
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v1/auth/refresh
                - Method=POST
            - id: auth-service-v1-logout
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v1/auth/logout
                - Method=POST
            - id: auth-service-v1-me
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v1/me
                - Method=GET
            - id: auth-service-v1-me-patch
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v1/me
                - Method=PATCH
            - id: auth-service-v1-me-password
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v1/me/password
                - Method=POST
            - id: auth-service-v1-admin-ping
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v1/admin/ping
                - Method=GET
            - id: auth-service-v1-admin-users-get
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v1/admin/users
                - Method=GET
            - id: auth-service-v1-admin-users-post
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v1/admin/users
                - Method=POST
            - id: auth-service-v1-admin-users-reset-password
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v1/admin/users/*/reset-password
                - Method=POST
            - id: auth-service-v1-admin-users-delete
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v1/admin/users/**
                - Method=DELETE

            - id: auth-service-login
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v2/auth/login
                - Method=POST
              filters:
                - SetPath=/v1/auth/login
            - id: auth-service-refresh
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v2/auth/refresh
                - Method=POST
              filters:
                - SetPath=/v1/auth/refresh
            - id: auth-service-logout
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v2/auth/logout
                - Method=POST
              filters:
                - SetPath=/v1/auth/logout
            - id: auth-service-activate
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/activate
                - Method=POST
            - id: auth-service-me
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v2/auth/me
                - Method=GET
              filters:
                - SetPath=/v1/me
            - id: auth-service-admin-ping
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v2/auth/admin/ping
                - Method=GET
              filters:
                - SetPath=/v1/admin/ping
            - id: auth-service-admin-users-get
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v2/auth/admin/users
                - Method=GET
              filters:
                - SetPath=/v1/admin/users
            - id: auth-service-admin-users-post
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v2/auth/admin/users
                - Method=POST
              filters:
                - SetPath=/v1/admin/users
            - id: auth-service-admin-users-delete
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v2/auth/admin/users/**
                - Method=DELETE
              filters:
                - RewritePath=/v2/auth/admin/users/(?<segment>.*), /v1/admin/users/$\{segment}

            - id: post-service-v1-images
              uri: ${POST_SERVICE_URI:http://localhost:8084}
              predicates:
                - Path=/v1/images
                - Method=POST
            - id: post-service-v1-posts-root-get
              uri: ${POST_SERVICE_URI:http://localhost:8084}
              predicates:
                - Path=/v1/posts
                - Method=GET
            - id: post-service-v1-posts-root-post
              uri: ${POST_SERVICE_URI:http://localhost:8084}
              predicates:
                - Path=/v1/posts
                - Method=POST
            - id: post-service-v1-posts-drafts
              uri: ${POST_SERVICE_URI:http://localhost:8084}
              predicates:
                - Path=/v1/posts/drafts
                - Method=GET
            - id: post-service-v1-posts-subpaths-get
              uri: ${POST_SERVICE_URI:http://localhost:8084}
              predicates:
                - Path=/v1/posts/**
                - Method=GET
            - id: post-service-v1-posts-subpaths-patch
              uri: ${POST_SERVICE_URI:http://localhost:8084}
              predicates:
                - Path=/v1/posts/**
                - Method=PATCH
            - id: post-service-v1-posts-subpaths-delete
              uri: ${POST_SERVICE_URI:http://localhost:8084}
              predicates:
                - Path=/v1/posts/**
                - Method=DELETE

            - id: post-service-openapi-root
              uri: ${POST_SERVICE_URI:http://localhost:8084}
              predicates:
                - Path=/v2/post/v3/api-docs
              filters:
                - SetPath=/v3/api-docs
            - id: post-service-openapi-subpaths
              uri: ${POST_SERVICE_URI:http://localhost:8084}
              predicates:
                - Path=/v2/post/v3/api-docs/**
              filters:
                - RewritePath=/v2/post/v3/api-docs/(?<segment>.*), /v3/api-docs/$\{segment}
            - id: auth-service-openapi-root
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v2/auth/v3/api-docs
              filters:
                - SetPath=/v3/api-docs
            - id: auth-service-openapi-subpaths
              uri: ${AUTH_SERVICE_URI:http://localhost:9000}
              predicates:
                - Path=/v2/auth/v3/api-docs/**
              filters:
                - RewritePath=/v2/auth/v3/api-docs/(?<segment>.*), /v3/api-docs/$\{segment}
            - id: post-service-images-root
              uri: ${POST_SERVICE_URI:http://localhost:8084}
              predicates:
                - Path=/v2/post/images
              filters:
                - SetPath=/v1/images
            - id: post-service-images-subpaths
              uri: ${POST_SERVICE_URI:http://localhost:8084}
              predicates:
                - Path=/v2/post/images/**
              filters:
                - RewritePath=/v2/post/images/(?<segment>.*), /v1/images/$\{segment}
            - id: post-service-posts-root
              uri: ${POST_SERVICE_URI:http://localhost:8084}
              predicates:
                - Path=/v2/post
              filters:
                - SetPath=/v1/posts
            - id: post-service-posts-subpaths
              uri: ${POST_SERVICE_URI:http://localhost:8084}
              predicates:
                - Path=/v2/post/**
              filters:
                - RewritePath=/v2/post/(?<segment>.*), /v1/posts/$\{segment}
          httpclient:
            connect-timeout: 3000
            response-timeout: 10s

server:
  port: ${SERVER_PORT:8080}
  max-http-request-header-size: ${MAX_REQUEST_HEADER_SIZE:16KB}

security:
  jwt:
    issuer: ${AUTH_ISSUER_URI:http://localhost:9000}
    audience: ${AUTH_AUDIENCE:aandi-gateway}
    secret: ${AUTH_JWT_SECRET:local-dev-jwt-secret-must-be-at-least-32-bytes}
    clock-skew-seconds: ${AUTH_JWT_CLOCK_SKEW_SECONDS:30}

springdoc:
  swagger-ui:
    path: /v2/swagger-ui/index.html
    urls:
      - name: auth-service
        url: /v2/auth/v3/api-docs
      - name: post-service
        url: /v2/post/v3/api-docs

management:
  server:
    port: ${MANAGEMENT_SERVER_PORT:9090}
    address: ${MANAGEMENT_SERVER_ADDRESS:127.0.0.1}
  endpoints:
    web:
      exposure:
        include: health, info
  endpoint:
    health:
      show-details: always

logging:
  level:
    org.springframework.cloud.gateway: INFO
    io.lettuce.core: WARN

app:
  security:
    internal-event-token: ${INTERNAL_EVENT_TOKEN}
    policy:
      enforce-https: ${ENFORCE_HTTPS:false}
      enforce-method-path-allowlist: ${ENFORCE_METHOD_PATH_ALLOWLIST:true}
      enforce-json-content-type: ${ENFORCE_JSON_CONTENT_TYPE:true}
      allow-private-ip-host: ${ALLOW_PRIVATE_IP_HOST:true}
      prevalidate-refresh-token-type: ${PREVALIDATE_REFRESH_TOKEN_TYPE:true}
      allowed-hosts: ${ALLOWED_HOSTS:}
    rate-limit:
      enabled: ${AUTH_RATE_LIMIT_ENABLED:true}
      login-per-minute: ${AUTH_LOGIN_RATE_LIMIT_PER_MINUTE:10}
      refresh-per-minute: ${AUTH_REFRESH_RATE_LIMIT_PER_MINUTE:30}
      logout-per-minute: ${AUTH_LOGOUT_RATE_LIMIT_PER_MINUTE:30}
  token-cache:
    ttl: ${TOKEN_CACHE_TTL:24h}
